<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HARRY6</title>

  <style>
    :root{
      --text:#111;
      --muted: rgba(0,0,0,.48);
      --muted2: rgba(0,0,0,.30);
      --line: rgba(0,0,0,.10);
      --leftPad: 56px;
      --panelW: 360px;
      --panelPad: 18px;
    }
    *{ box-sizing:border-box; }
    html, body{
      height:100%;
      margin:0;
      background:#fff;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "PingFang SC","Microsoft YaHei", sans-serif;
    }

    /* p5 stage */
    #stage{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 1;
    }
    canvas{ display:block; pointer-events:auto; }

    /* brand */
    .brand{
      position:fixed;
      top:44px;
      left:var(--leftPad);
      z-index:1000;
      text-decoration:none;
      color:var(--text);
      font-weight:600;
      font-size:18px;
      letter-spacing:.10em;
      text-transform:uppercase;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.85);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: opacity .15s ease, box-shadow .15s ease;
    }
    .brand:hover{
      opacity:.78;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    /* nav */
    .nav{
      position:fixed;
      left:var(--leftPad);
      top:50%;
      transform:translateY(-50%);
      z-index:1000;
      user-select:none;
    }
    .navItem{ margin: 18px 0; }

    .navBtn{
      display:inline-block;
      cursor:pointer;
      border:none;
      background: rgba(255,255,255,0.85);
      padding: 10px 12px;
      margin-left:-12px;
      font-size:15px;
      letter-spacing:.24em;
      text-transform:uppercase;
      color:var(--text);
      border-radius: 999px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .navBtn:hover{
      color:var(--text);
      background: rgba(255,255,255,0.95);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .navBtn.is-active{ color:var(--text); }

    /* panel */
    .panel{
      position:fixed;
      width: var(--panelW);
      max-width: calc(100vw - 24px);
      background:#fff;
      border:1px solid var(--line);
      padding: var(--panelPad);
      z-index:1001;
      opacity:0;
      pointer-events:none;
      transform: translateY(-8px);
      transition: opacity .14s ease, transform .14s ease;
    }
    .panel.is-open{
      opacity:1;
      pointer-events:auto;
      transform: translateY(0);
    }
    .panel::before{
      content:"";
      position:absolute;
      left:-18px;
      top:0;
      width:18px;
      height:100%;
      background:transparent;
    }

    .panelList{ list-style:none; padding:0; margin:0; }
    .panelList li{ margin: 10px 0; }

    .panelLink{
      text-decoration:none;
      color:var(--text);
      font-size:16px;
      letter-spacing:.02em;
      display:inline-block;
      padding: 6px 4px;
    }
    .panelLink:hover{ opacity:.75; }
    .panelLink .year{
      color:var(--muted);
      margin-left:.35em;
      letter-spacing:.06em;
    }

    /* email */
    .emailWrap{
      position:fixed;
      left:50%;
      bottom:28px;
      transform:translateX(-50%);
      z-index:1000;
      font-size:13px;
      letter-spacing:.06em;
      color:var(--muted);
      text-align: center;
    }
    .emailCopy{
      cursor:pointer;
      padding: 6px 10px;
      border:1px solid transparent;
      border-radius:999px;
      background: rgba(255,255,255,0.85);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: border-color .15s ease, color .15s ease, box-shadow .15s ease;
    }
    .emailCopy:hover{
      border-color: var(--line);
      color: var(--text);
      background: rgba(255,255,255,0.95);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .hint{
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:rgba(0,0,0,.6);
      margin-bottom: 8px;
      display: none;
      font-weight: 500;
    }

    .toast{
      position:absolute;
      left:100%;
      top:50%;
      transform: translate(10px,-50%);
      font-size:12px;
      color:var(--muted2);
      letter-spacing:.18em;
      text-transform:uppercase;
      opacity:0;
      transition: opacity .18s ease;
      pointer-events:none;
    }
    .toast.show{ opacity:1; }

    /* 触摸设备：显示提示文字 */
    body.is-touch-device .hint{
      display: block;
    }

    /* 小屏幕设备（手机和部分平板）：调整布局 */
    @media (max-width: 1024px){
      :root{ --leftPad: 22px; --panelW: 320px; }
      .brand{ top:22px; }
      .navBtn{ font-size:14px; letter-spacing:.20em; }
    }
  </style>
</head>

<body>

  <script>
    // 检测是否为触摸设备
    function isTouchDevice() {
      return 'ontouchstart' in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0;
    }

    // 给 body 添加触摸设备标识
    if (isTouchDevice()) {
      document.body.classList.add('is-touch-device');
    }
  </script>

  <a id="homeLink" class="brand" href="#">HARRY6</a>

  <nav class="nav" aria-label="Primary">
    <div class="navItem" data-menu="projects"><button class="navBtn" type="button">PROJECTS</button></div>
    <div class="navItem" data-menu="images"><button class="navBtn" type="button">IMAGES</button></div>
    <div class="navItem" data-menu="about"><button class="navBtn" type="button">ABOUT</button></div>
  </nav>

  <div id="panel" class="panel" role="dialog" aria-hidden="true">
    <ul id="panelList" class="panelList"></ul>
  </div>

  <div class="emailWrap">
    <div class="hint">左右滑动 · 互动</div>
    <span id="emailCopy" class="emailCopy" title="Click to copy">wenhao_liu888@163.com</span>
    <span id="toast" class="toast">COPIED</span>
  </div>

  <div id="stage"></div>

  <script src="https://cdn.jsdelivr.net/npm/p5@1.11.11/lib/p5.js"></script>

  <script>
    // ===== 导航和面板逻辑 =====
    const REPO = location.pathname.split("/")[1];
    const BASE = REPO ? `/${REPO}/` : "/";
    document.getElementById("homeLink").setAttribute("href", BASE);

    const PROJECTS = [
      { title: "Yellow River", year: "2025", href: BASE + "projects/yellow-river/" },
      { title: "Frontispiece", year: "2024", href: BASE + "projects/frontispiece/" },
      { title: "Formless Buddha", year: "2023", href: BASE + "projects/formless-buddha/" },
      { title: "Yellow", year: "2021", href: BASE + "projects/yellow/" }
    ];

    const IMAGES = [
      { title: "Yellow River", year: "2025", href: BASE + "images/yellow-river/" }
    ];

    const ABOUT_HREF = BASE + "about/";

    const panel = document.getElementById("panel");
    const panelList = document.getElementById("panelList");
    const items = Array.from(document.querySelectorAll(".navItem"));
    const btns  = Array.from(document.querySelectorAll(".navBtn"));

    let activeKey = null;
    let closeTimer = null;

    function setActiveButton(key){
      btns.forEach(b => b.classList.remove("is-active"));
      const item = items.find(i => i.dataset.menu === key);
      if(item) item.querySelector(".navBtn").classList.add("is-active");
    }

    function renderList(list){
      panelList.innerHTML = list.map(it => `
        <li>
          <a class="panelLink" href="${it.href}">
            ${it.title} <span class="year">— ${it.year}</span>
          </a>
        </li>
      `).join("");
    }

    function positionPanelNearButton(btn){
      const r = btn.getBoundingClientRect();
      const gap = 14;
      let left = Math.round(r.right + gap);
      let top  = Math.round(r.top + r.height/2);

      panel.style.top = `${top}px`;
      panel.style.transform = "translateY(-50%)";

      const panelWidth = Math.min(panel.offsetWidth || 360, window.innerWidth - 24);
      if(left + panelWidth + 12 > window.innerWidth){
        left = Math.round(r.left - gap - panelWidth);
      }
      left = Math.max(12, left);
      panel.style.left = `${left}px`;
    }

    function openPanelFor(key, btn){
      clearTimeout(closeTimer);
      activeKey = key;
      setActiveButton(key);

      if(key === "projects") renderList(PROJECTS);
      if(key === "images") renderList(IMAGES);

      panel.classList.add("is-open");
      panel.setAttribute("aria-hidden","false");
      requestAnimationFrame(() => positionPanelNearButton(btn));
    }

    function closePanel(){
      activeKey = null;
      btns.forEach(b => b.classList.remove("is-active"));
      panel.classList.remove("is-open");
      panel.setAttribute("aria-hidden","true");
    }

    function scheduleClose(){
      clearTimeout(closeTimer);
      closeTimer = setTimeout(closePanel, 220);
    }

    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    items.forEach(item => {
      const key = item.dataset.menu;
      const btn = item.querySelector(".navBtn");

      // 电脑端：hover 效果
      if(!isTouchDevice && (key === "projects" || key === "images")){
        item.addEventListener("mouseenter", () => openPanelFor(key, btn));
        item.addEventListener("mouseleave", scheduleClose);
      }

      // 手机端：使用 touchstart 代替 click，响应更快
      if(isTouchDevice){
        btn.addEventListener("touchstart", (e) => {
          e.preventDefault(); // 防止触发 click 事件
          if(key === "about"){
            window.location.href = ABOUT_HREF;
            return;
          }
          if(panel.classList.contains("is-open") && activeKey === key){
            closePanel();
          }else{
            openPanelFor(key, btn);
          }
        }, {passive: false});
      }else{
        // 电脑端：click 事件
        btn.addEventListener("click", (e) => {
          if(key === "about"){
            window.location.href = ABOUT_HREF;
            e.preventDefault();
            return;
          }
          if(panel.classList.contains("is-open") && activeKey === key){
            closePanel();
          }else{
            openPanelFor(key, btn);
          }
          e.preventDefault();
        });
      }
    });

    // 电脑端：面板 hover 保持打开
    if(!isTouchDevice){
      panel.addEventListener("mouseenter", () => clearTimeout(closeTimer));
      panel.addEventListener("mouseleave", scheduleClose);
    }

    // 点击外部关闭面板（电脑端）
    if(!isTouchDevice){
      document.addEventListener("mousedown", (e) => {
        const isNav = e.target.closest(".nav");
        const isPanel = e.target.closest("#panel");
        if(!isNav && !isPanel && panel.classList.contains("is-open")) closePanel();
      });
    }

    // 触摸外部关闭面板（手机端）
    if(isTouchDevice){
      document.addEventListener("touchstart", (e) => {
        const isNav = e.target.closest(".nav");
        const isPanel = e.target.closest("#panel");
        if(!isNav && !isPanel && panel.classList.contains("is-open")) closePanel();
      });
    }

    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && panel.classList.contains("is-open")) closePanel();
    });

    // 邮箱复制
    const emailEl = document.getElementById("emailCopy");
    const toast = document.getElementById("toast");
    let toastTimer = null;

    async function copyEmail(){
      const text = emailEl.textContent.trim();
      try{
        await navigator.clipboard.writeText(text);
      }catch(err){
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
      }
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toast.classList.remove("show"), 900);
    }
    emailEl.addEventListener("click", copyEmail);
  </script>

  <script>
    // ===== P5.js 动画（必须分开一个 script 标签）=====
    // 等待页面完全加载后再执行
    window.addEventListener('load', function() {
      console.log("页面完全加载，开始初始化 p5.js");

      // 创建 p5 实例 - Digital Strata 故障艺术动画
      new p5(function(p) {
        let img;
        let originalImg; // 保存原始图片，避免反复 resize 导致质量损失
        let smoothPresence = 0.0;

        p.preload = function() {
          originalImg = p.loadImage("LWH_8128.JPG");
        };

        p.setup = function() {
          // 根据屏幕大小计算尺寸，保持 2:3 比例，确保有留白
          // 减去顶部导航和底部邮箱的空间
          let availableHeight = p.windowHeight - 150;
          let availableWidth = p.windowWidth - 100;

          // 计算高度（取可用高度的 85%）
          let h = Math.floor(availableHeight * 0.85);
          // 根据宽高比 2:3 计算宽度
          let w = Math.floor(h * 2 / 3);

          // 如果宽度超出可用空间，按宽度重新计算
          if (w > availableWidth) {
            w = Math.floor(availableWidth * 0.9);
            h = Math.floor(w * 3 / 2);
          }

          // 不超过原始尺寸 500×750
          w = Math.min(w, 500);
          h = Math.min(h, 750);

          let cnv = p.createCanvas(w, h);
          cnv.parent("stage");
          p.pixelDensity(1);
          p.frameRate(60);

          console.log("Canvas 尺寸:", p.width, "x", p.height);

          if (originalImg) {
            // 从原始图片创建副本并 resize
            img = originalImg.get();
            img.resize(p.width, p.height);
          }
        };

        p.draw = function() {
          // 检测设备类型 - 支持触摸
          let pointerX = p.mouseX;
          if (p.touches.length > 0) {
            pointerX = p.touches[0].x;
          }

          let distFromCenter = p.abs(p.width / 2 - pointerX);
          let distFactor = p.map(distFromCenter, 0, p.width / 2, 1.0, 0.0);
          smoothPresence = p.lerp(smoothPresence, distFactor, 0.03);

          let glitchIntensity = 1.0 - smoothPresence;

          // 底图控制（冻结效果）
          if (smoothPresence > 0.05 && img) {
            p.tint(255, smoothPresence * 255);
            p.image(img, 0, 0);
            p.noTint();
          }

          // 横向拉伸故障效果
          let count = Math.floor(p.map(glitchIntensity, 0, 1, 0, 40));

          for (let i = 0; i < count; i++) {
            let y = Math.floor(p.random(p.height));
            let h = Math.floor(p.random(2, 15));
            let x = Math.floor(p.width / 2 + p.random(-50, 50));
            let w = Math.floor(p.random(1, 3));

            p.copy(img, x, y, w, h, 0, y, p.width, h);
          }

          // 局部修复
          if (smoothPresence > 0.2) {
            let restoreCount = Math.floor(p.map(smoothPresence, 0, 1, 0, 200));
            for (let i = 0; i < restoreCount; i++) {
              let x = Math.floor(p.random(p.width));
              let y = Math.floor(p.random(p.height));
              let w = Math.floor(p.random(20, 100));
              let h = Math.floor(p.random(2, 5));
              p.copy(img, x, y, w, h, x, y, w, h);
            }
          }
        };

        p.windowResized = function() {
          // 根据屏幕大小重新计算尺寸，保持 2:3 比例
          let availableHeight = p.windowHeight - 150;
          let availableWidth = p.windowWidth - 100;

          let h = Math.floor(availableHeight * 0.85);
          let w = Math.floor(h * 2 / 3);

          if (w > availableWidth) {
            w = Math.floor(availableWidth * 0.9);
            h = Math.floor(w * 3 / 2);
          }

          w = Math.min(w, 500);
          h = Math.min(h, 750);

          p.resizeCanvas(w, h);

          // 从原始图片创建副本并 resize，避免质量损失
          if (originalImg) {
            img = originalImg.get();
            img.resize(p.width, p.height);
          }
        };

        p.touchStarted = function() {
          if (p.mouseX > 0 && p.mouseX < p.width && p.mouseY > 0 && p.mouseY < p.height) {
            return false;
          }
          return true;
        };
      });
    });
  </script>

</body>
</html>
